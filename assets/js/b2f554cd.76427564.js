"use strict";(self.webpackChunkbyconity=self.webpackChunkbyconity||[]).push([[477],{10:n=>{n.exports=JSON.parse('{"blogPosts":[{"id":"2023-08-22-RoCE-on-kubernetes","metadata":{"permalink":"/blog/2023-08-22-RoCE-on-kubernetes","editUrl":"https://github.com/ByConity/byconity.github.io/tree/main/blog/2023-08-22-RoCE-on-kubernetes/index.md","source":"@site/blog/2023-08-22-RoCE-on-kubernetes/index.md","title":"\u5728 k8s \u4e0a\u4f7f\u7528 RoCE \u7f51\u7edc","description":"\u90e8\u7f72 k8s \u96c6\u7fa4","date":"2023-08-22T00:00:00.000Z","formattedDate":"2023\u5e748\u670822\u65e5","tags":[{"label":"video introduction","permalink":"/blog/tags/video-introduction"},{"label":"docusaurus","permalink":"/blog/tags/docusaurus"}],"readingTime":3.245,"hasTruncateMarker":false,"authors":[{"name":"\u6731\u4e9a\u5149","title":"\u667a\u80fd\u539f\u751f\u793e\u533a\u6210\u5458","url":"https://github.com/zhuyaguang","imageURL":"https://github.com/zhuyaguang.png","key":"zhuyaguang"}],"frontMatter":{"slug":"2023-08-22-RoCE-on-kubernetes","date":"2023-08-22T00:00:00.000Z","title":"\u5728 k8s \u4e0a\u4f7f\u7528 RoCE \u7f51\u7edc","authors":["zhuyaguang"],"tags":["video introduction","docusaurus"],"keywords":["k8s","RDMA","RoCE"]}},"content":"## \u90e8\u7f72 k8s \u96c6\u7fa4\\n\\n- \u9009\u62e9 \u5408\u9002\u7684 \u5bb9\u5668\u7f51\u7edc\\n\\n## \u90e8\u7f72 k8s-device-plugin\\n\\n\u9009\u62e9\u6700\u65b0\u7684\u7248\u672c\\n\\n- https://github.com/NVIDIA/k8s-device-plugin\\n\\n## \u90e8\u7f72 RDMA \u63d2\u4ef6\\n\\n### \u65b9\u6848\u4e00\uff1a\u4f7f\u7528\u963f\u91cc\u7684\u955c\u50cf\\n\\n\u6765\u81ea\u6587\u7ae0\uff1a[\u5728 Kubernetes \u4e0a\u4f7f\u7528 RDMA](https://developer.aliyun.com/article/664961)\\n\\n```yaml\\napiVersion: v1\\nkind: ConfigMap\\nmetadata:\\n  name: rdma-devices\\n  namespace: kube-system\\ndata:\\n  config.json: |\\n    {\\n        \\"mode\\" : \\"hca\\"\\n    }\\n\\n---\\napiVersion: apps/v1\\nkind: DaemonSet\\nmetadata:\\n  name: rdma-device-plugin\\n  namespace: kube-system\\nspec:\\n  selector:\\n    matchLabels:\\n      name: rdma-sriov-dp-ds\\n  template:\\n    metadata:\\n      annotations:\\n        scheduler.alpha.kubernetes.io/critical-pod: \'\'\\n      labels:\\n        name: rdma-sriov-dp-ds\\n    spec:\\n      hostNetwork: true\\n      tolerations:\\n        - key: CriticalAddonsOnly\\n          operator: Exists\\n      containers:\\n        - image: registry.cn-shanghai.aliyuncs.com/acs/rdma-device-plugin\\n          name: k8s-rdma-device-plugin\\n          imagePullPolicy: IfNotPresent\\n          securityContext:\\n            privileged: true\\n          volumeMounts:\\n            - name: device-plugin\\n              mountPath: /var/lib/kubelet/device-plugins\\n            - name: config\\n              mountPath: /k8s-rdma-sriov-dev-plugin\\n      volumes:\\n        - name: device-plugin\\n          hostPath:\\n            path: /var/lib/kubelet/device-plugins\\n        - name: config\\n          configMap:\\n            name: rdma-devices\\n            items:\\n              - key: config.json\\n                path: config.json\\n```\\n\\n### \u7ed3\u8bba\\n\\n\u955c\u50cf\u7248\u672c\u592a\u8001\u4e86\uff0c\u800c\u4e14\u6ca1\u6709 device plugin \u7684\u6e90\u4ee3\u7801\uff0c\u65e0\u6cd5\u7ef4\u62a4\u3002\u4f46\u662f\u8bbe\u7f6e hostNetwork pod \u662f\u53ef\u4ee5 running \u8d77\u6765\u7684\uff0c\u8282\u70b9\u4e0a\u4e5f\u6709 hca \u8d44\u6e90\u3002\u6240\u4ee5\u8be5\u65b9\u6848\u4e0d\u63a8\u8350\uff01\\n\\n### \u65b9\u6848\u4e8c k8s-rdma-shared-dev-plugin\\n\\n```yaml\\napiVersion: v1\\nkind: ConfigMap\\nmetadata:\\n  name: rdma-devices\\n  namespace: kube-system\\ndata:\\n  config.json: |\\n    {\\n        \\"periodicUpdateInterval\\": 300,\\n        \\"configList\\": [\\n           {\\n             \\"resourceName\\": \\"hca_shared_devices_b\\",\\n             \\"rdmaHcaMax\\": 500,\\n             \\"selectors\\": {\\n               \\"deviceIDs\\": [\\"101b\\"]\\n             }\\n           }\\n        ]\\n    }\\n\\n---\\napiVersion: apps/v1\\nkind: DaemonSet\\nmetadata:\\n  name: rdma-shared-dp-ds\\n  namespace: kube-system\\nspec:\\n  selector:\\n    matchLabels:\\n      name: rdma-shared-dp-ds\\n  template:\\n    metadata:\\n      labels:\\n        name: rdma-shared-dp-ds\\n    spec:\\n      hostNetwork: true\\n      priorityClassName: system-node-critical\\n      containers:\\n        - image: ghcr.io/mellanox/k8s-rdma-shared-dev-plugin\\n          name: k8s-rdma-shared-dp-ds\\n          imagePullPolicy: IfNotPresent\\n          securityContext:\\n            privileged: true\\n          volumeMounts:\\n            - name: device-plugin\\n              mountPath: /var/lib/kubelet/\\n            - name: config\\n              mountPath: /k8s-rdma-shared-dev-plugin\\n            - name: devs\\n              mountPath: /dev/\\n      volumes:\\n        - name: device-plugin\\n          hostPath:\\n            path: /var/lib/kubelet/\\n        - name: config\\n          configMap:\\n            name: rdma-devices\\n            items:\\n              - key: config.json\\n                path: config.json\\n        - name: devs\\n          hostPath:\\n            path: /dev/\\n```\\n\\n> \u4e0a\u9762\u914d\u7f6e\u4e2d\uff0c\\"deviceIDs\\": [\\"101b\\"] \u901a\u8fc7 cat /sys/class/infiniband/mlx5_2/device/device \u547d\u4ee4\u67e5\u51fa\u6765\u3002\\n\\n\u5982\u4f55\u5224\u65ad\uff0cdevice plugin \u5b89\u88c5\u6210\u529f\u5462\uff0cdescribe node \u53d1\u73b0\u8d44\u6e90\u6302\u8f7d\u6210\u529f\u5c31\u53ef\u4ee5\u4e86\\n\\n![image-20230821142528961](https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20230821142528961.png)\\n\\n### \u65b9\u6848\u4e8c \u6d4b\u8bd5\\n\\n```yaml\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  name: mofed-test-pod\\nspec:\\n  restartPolicy: OnFailure\\n  nodeName: 10.106.124.3\\n  hostNetwork: true\\n  containers:\\n    - image: mellanox/rping-test\\n      name: mofed-test-ctr\\n      securityContext:\\n        capabilities:\\n          add: [\'IPC_LOCK\']\\n      resources:\\n        limits:\\n          rdma/hca_shared_devices_b: 1\\n      command:\\n        - sh\\n        - -c\\n        - |\\n          ls -l /dev/infiniband /sys/class/infiniband /sys/class/net\\n          sleep 1000000\\n\\n---\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  name: mofed-test-pod2\\nspec:\\n  restartPolicy: OnFailure\\n  nodeName: 10.106.124.4\\n  hostNetwork: true\\n  containers:\\n    - image: mellanox/rping-test\\n      name: mofed-test-ctr\\n      securityContext:\\n        capabilities:\\n          add: [\'IPC_LOCK\']\\n      resources:\\n        limits:\\n          rdma/hca_shared_devices_b: 1\\n      command:\\n        - sh\\n        - -c\\n        - |\\n          ls -l /dev/infiniband /sys/class/infiniband /sys/class/net\\n          sleep 1000000\\n```\\n\\n- \u6d4b\u8bd5\u547d\u4ee4 1\\n\\n```\\nib\\\\_read\\\\_bw -q 30\\n\\nib\\\\_read\\\\_bw -q 30 10.106.156.3\\n```\\n\\n![image-20230821142703589](https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20230821142703589.png)\\n\\n- \u6d4b\u8bd5\u547d\u4ee4 2\\n\\n```\\nib_write_bw -d mlx5_2  -F --report_gbits\\n\\nib_write_bw -d mlx5_2 -F --report_gbits 10.106.156.3\\n```\\n\\n![image-20230821143421094](https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20230821143421094.png)\\n\\n![image-20230821171553969](https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20230821171553969.png)\\n\\n- \u6d4b\u8bd5\u547d\u4ee4 3\\n\\n  ```\\n  ib_send_bw -d mlx5_3 -i 1 -R --report_gbits\\n  ib_send_bw -d mlx5_3 -i 1 -R --report_gbits 10.106.156.4\\n  ```\\n\\n- \u6d4b\u8bd5\u547d\u4ee4 4\\n\\n  ```\\n  ib_write_bw -d mlx5_3 -a -F\\n\\n  ib_write_bw  -F -d mlx5_3 10.233.92.6 -D 10 --cpu_util --report_gbits\\n  ```\\n\\n### \u5e38\u7528\u547d\u4ee4\\n\\n- \u67e5\u770b\u5b58\u50a8 InfiniBand \u8bbe\u5907\u8282\u70b9\u7684\u76ee\u5f55\\n\\n  ls /dev/infiniband/\\n\\n- \u67e5\u770b\u7f51\u5361\\n\\n  ibdev2netdev\\n\\n- \u67e5\u8be2\u7f51\u5361 IP\\n\\n  ip a show dev enp88s0\\n\\n- \u67e5\u770b\u8bbe\u5907 ID\\n\\n  cat /sys/class/infiniband/mlx5_bond_0/device/device\\n\\n  cat /sys/class/infiniband/mlx5_2/device/device\\n\\n- \u67e5\u770b\u7f51\u5361\u578b\u53f7\\n\\n`lspci -s 0000:17:00.0`\\n\\n![image-20230821113834360](https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20230821113834360.png)\\n\\n- \u67e5\u770b\u8bbe\u5907\u548c\u7f51\u5361\\n\\n  ls -la /dev/infiniband /sys/class/net\\n\\n- \u67e5\u8be2 InfiniBand\uff08IB\uff09\u8bbe\u5907\u7684\u72b6\u6001\u548c\u914d\u7f6e\u4fe1\u606f\\n\\n  ibv_devinfo\\n\\n## \u53c2\u8003\u6587\u6863\\n\\n[k8s RoCE \u90e8\u7f72: k8s-rdma-shared-dev-plugin + macvlan cni](https://blog.csdn.net/sunshuying1010/article/details/124951208)\\n\\n[\u5728 Kubernetes \u4e0a\u4f7f\u7528 RDMA](https://developer.aliyun.com/article/664961)\\n\\n### device plugin\\n\\nhttps://github.com/Mellanox/k8s-rdma-shared-dev-plugin \u63a8\u8350\\n\\n**https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin** \u725b\u54e5\u4f7f\u7528\u7684\uff0cstar \u6570\u6700\u9ad8\\n\\nhttps://github.com/hustcat/k8s-rdma-device-plugin"}]}')}}]);